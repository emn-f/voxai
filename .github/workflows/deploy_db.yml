name: ğŸ² Deploy Database Changes

on:
  push:
    branches:
      - master
    paths:
      - 'supabase/migrations/**'

jobs:
  deploy_migrations:
    runs-on: ubuntu-latest
    # ğŸ”¥ AQUI ESTÃ O SEGREDO: Definimos as chaves para o JOB inteiro
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD_PROD }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID_PROD }}

    steps:
      - name: ğŸ“¥ Checkout do CÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”¬ AnÃ¡lise TÃ©cnica
        run: |
          echo "ğŸ“‚ ARQUIVOS ENCONTRADOS"
          ls -1 supabase/migrations/*.sql 2>/dev/null || echo "Nenhum arquivo .sql encontrado"
      - name: ğŸ•µï¸ Debug de Secrets
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "âŒ ERRO CRÃTICO: O token SUPABASE_ACCESS_TOKEN estÃ¡ vazio ou nÃ£o foi carregado!"
            exit 1
          else
            echo "âœ… Token carregado"
          fi

      - name: ğŸ› ï¸ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”— Link e Push (ProduÃ§Ã£o)
        run: |
          echo "ğŸ”Œ Conectando ao projeto..."
          supabase link --project-ref $SUPABASE_PROJECT_ID
          
          echo "ğŸš€ Enviando migraÃ§Ãµes..."
          supabase db push

      - name: ğŸ‰ Sucesso
        if: success()
        run: echo "âœ… Banco de dados atualizado com sucesso!"

      - name: âŒ Falha
        if: failure()
        run: echo "ğŸ”¥ Ocorreu um erro. Verifique os logs."